{
  "hash": "68554ed3a265adff80691f35bcd99937",
  "result": {
    "markdown": "# METABRIC\n\n## Packages to use\n\nFirst load the packages that will be used along the cleaning\nprocess. Always do this at the beginning of your script to make\nthings organized. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(TCGAbiolinks)\nlibrary(singscore)\nlibrary(GEOquery)\n\nlibrary(SummarizedExperiment)\n```\n:::\n\n\n## Introduction\n\nTo download the clinical data and expression levels from the METABRIC cohort\ngo to cbioportal and select the respective cohort (METABRIC):\nhttps://www.cbioportal.org/\n\nHere we will load and format the metabric data in the same way as\nSCAN-B and the AI dataset, \nso it is standardized and better to use in future analysis. \nFor this, we use the summarized experiment object to store expression data\nand clinical information.\n\n\nLoading gene expression levels. \n::: {.cell}\n\n```{.r .cell-code}\nexpression_data <- read.csv(\n  \"Data/20210713_metabric/data_mRNA_median_all_sample_Zscores.txt\",\n  sep = \"\\t\",\n  check.names = FALSE\n)\n\ndim(expression_data)\n```\n:::\n\nWe note that the first two columns correspond to HUGO symbol and ENTREZ ID.\n\nSince genes were znormalized, we select the first appearance in the list\nof genes that are duplicated.\n\n::: {.cell}\n\n```{.r .cell-code}\nexpression_data <- expression_data[!duplicated(expression_data$Hugo_Symbol), ]\n```\n:::\n\nLoad now clinical data.\n\n::: {.cell}\n\n```{.r .cell-code}\nclinical_data <- read.csv(\n  \"Data/20210713_metabric/data_clinical_patient.txt\",\n  sep = \"\\t\",\n  comment.char = \"#\"\n)\n\nglimpse(clinical_data)\n```\n:::\n\nWe see that there are over 2500 rows, meaning that we have more patients with\nclinical data than expression levels. Let us now select patients that have\nexpression levels.\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(unique(clinical_data$PATIENT_ID)) == nrow(clinical_data)\n```\n:::\n\nWe see that each row has a unique identifier, the patient ID, so we set\nthis as a rowname.\n\n::: {.cell}\n\n```{.r .cell-code}\nrownames(clinical_data) <- clinical_data$PATIENT_ID\n```\n:::\n\nAnd we check if all patients from expression data have clinical data.\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(intersect(clinical_data$PATIENT_ID, colnames(expression_data[, -c(1,2)]))) ==\n  ncol(expression_data)-2\n```\n:::\n\nIndeed it has, therefore we can just subselect clinical data and create the \nfile like TCGA and SCAN-B.\n\n::: {.cell}\n\n```{.r .cell-code}\nclinical_data <- clinical_data[colnames(expression_data[, -c(1,2)]), ]\nrownames(expression_data) <- expression_data$Hugo_Symbol\nrow_ranges <- expression_data[, c(1,2)]\nexpression_data <- expression_data[, -c(1,2)]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmetabric_intensity_values <- read.delim(\n    \"Data/20210713_metabric/data_expression_median.txt\",\n    sep = \"\\t\",\n    header = TRUE\n) %>% dplyr::mutate(Entrez_Gene_Id = NULL) %>%\n    `colnames<-`(stringr::str_replace_all(colnames(.), stringr::fixed(\".\"), \"-\"))\n```\n:::\n\nBefore we just average the duplicated genes median intensity. \n\n::: {.cell}\n\n```{.r .cell-code}\nduplicated_genes <- metabric_intensity_values$Hugo_Symbol[duplicated(metabric_intensity_values$Hugo_Symbol)]\nmedian_genes <- sapply(\n    metabric_intensity_values$Hugo_Symbol[\n        duplicated(metabric_intensity_values$Hugo_Symbol)\n    ] %>% unique,\n    function(gene, df){\n        df %>% dplyr::filter(Hugo_Symbol == gene) %>%\n            dplyr::mutate(Hugo_Symbol = NULL) %>%\n            as.matrix(.) %>%\n            MatrixGenerics::colMedians(.)\n    },\n    df = metabric_intensity_values\n)\n\nmetabric_exp <- metabric_intensity_values\nmetabric_exp <- metabric_exp[!duplicated(metabric_exp$Hugo_Symbol), ]\nrownames(metabric_exp) <- metabric_exp$Hugo_Symbol\nmetabric_exp$Hugo_Symbol <- NULL\nmetabric_exp[colnames(median_genes), ] <- median_genes %>% t\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# add new clinical data to the summarized experiment object.\nmetabric <- SummarizedExperiment::SummarizedExperiment(\n    assays = list(\n        zscores = expression_data, \n        median_intensity = metabric_exp[\n            rownames(expression_data), \n            colnames(expression_data)\n        ]\n    ), \n    colData = clinical_data\n)\n```\n:::\n\nAdd ranking of the genes.\n::: {.cell}\n\n```{.r .cell-code}\nassay(metabric, \"rank\") <- singscore::rankGenes(assay(metabric, \"median_intensity\"))\n```\n:::\n\nLoad also the median intensity values as well.\n\n::: {.cell}\n\n```{.r .cell-code}\n# save the final dataset\nsaveRDS(\n    metabric, \n    file = file.path(\"Data/20210713_metabric/metabric_filtered.rds\")\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite.csv(x = row_ranges, file = \"Data/20210713_metabric/HUGO_ENTREZ.csv\", row.names = FALSE)\n```\n:::",
    "supporting": [
      "metabric_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": null
  }
}